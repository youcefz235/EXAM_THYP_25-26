<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Liste des cours</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            background: #f5f7fb;
        }
        header {
            background: #0f172a;
            color: #fff;
            padding: 16px 24px;
        }
        header h1 {
            margin: 0;
            font-size: 20px;
        }
        header p {
            margin: 4px 0 0;
            font-size: 12px;
            opacity: .8;
        }
        main {
            max-width: 900px;
            margin: 24px auto;
            padding: 0 16px 32px;
        }
        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .toolbar input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 999px;
            border: 1px solid #cbd5f5;
            font-size: 14px;
        }
        .toolbar button {
            padding: 10px 16px;
            border-radius: 999px;
            border: none;
            background: #2563eb;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }
        .toolbar button:hover {
            background: #1d4ed8;
        }
        #status {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        ul#cours-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        ul#cours-list li {
            background: #fff;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(15,23,42,.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }
        .cours-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .cours-id {
            font-size: 12px;
            color: #6b7280;
        }
        .cours-title {
            font-weight: 600;
        }
        .omk-link a {
            font-size: 12px;
            color: #2563eb;
            text-decoration: none;
        }
        .omk-link a:hover {
            text-decoration: underline;
        }
        .empty {
            font-size: 14px;
            color: #6b7280;
            margin-top: 8px;
        }
    </style>
</head>
<body>
<header>
    <h1>Liste des cours</h1>
    <p>Examen THYP du 9 décembre 2025 – page <code>cours.html</code></p>
</header>

<main>
    <div class="toolbar">
        <input id="search" type="text" placeholder="Filtrer les cours par mot-clé…">
        <button id="btn-reload">Recharger</button>
    </div>
    <div id="status"></div>
    <ul id="cours-list"></ul>
    <div id="empty-msg" class="empty"></div>
</main>

<script>
    // ⚠️ URL de ton Omeka local
    const API_BASE = "http://localhost/omeka-s2/api";

    // ID du modèle de ressource "cours" (vu dans ton JSON : resource_templates/4)
    const TEMPLATE_COURS_ID = 4;

    // 1) Récupérer les items depuis l'API Omeka
    async function getCours(searchTerm = "") {
        // On récupère tout puis on filtre en JS (plus simple pour l'examen)
        const url = API_BASE + "/items?per_page=1000";
        const response = await fetch(url);

        if (!response.ok) {
            throw new Error("Erreur API : " + response.status);
        }

        const items = await response.json();

        // Garder uniquement les items dont le resource_template est "cours"
        let cours = items.filter(it =>
            it["o:resource_template"]
            && it["o:resource_template"]["o:id"] === TEMPLATE_COURS_ID
        );

        // Petit filtre texte côté client (sur titre / identifiant)
        if (searchTerm.trim() !== "") {
            const q = searchTerm.toLowerCase();
            cours = cours.filter(it => {
                const titre = getFirstValue(it["dcterms:title"]);
                const ident = getFirstValue(it["dcterms:identifier"]);
                return (titre && titre.toLowerCase().includes(q)) ||
                       (ident && ident.toLowerCase().includes(q));
            });
        }

        return cours;
    }

    // 2) Afficher la liste des cours
    function showCours(cours) {
        const list = document.getElementById("cours-list");
        const emptyMsg = document.getElementById("empty-msg");
        list.innerHTML = "";
        emptyMsg.textContent = "";

        if (!cours || cours.length === 0) {
            emptyMsg.textContent = "Aucun cours trouvé.";
            return;
        }

        cours.forEach(item => {
            const li = document.createElement("li");

            const idOmeka = item["o:id"];
            const ident = getFirstValue(item["dcterms:identifier"]) || "(sans identifiant)";
            const titre = getFirstValue(item["dcterms:title"]) || "(sans titre)";

            const infoDiv = document.createElement("div");
            infoDiv.className = "cours-info";
            infoDiv.innerHTML = `
                <div class="cours-title">${titre}</div>
                <div class="cours-id">Identifiant : ${ident}</div>
            `;

            const linkDiv = document.createElement("div");
            linkDiv.className = "omk-link";
            linkDiv.innerHTML = `
                <a href="http://localhost/omeka-s2/admin/item/${idOmeka}" target="_blank">
                    Voir dans Omeka
                </a>
            `;

            li.appendChild(infoDiv);
            li.appendChild(linkDiv);
            list.appendChild(li);
        });
    }

    // 3) Fonction utilitaire pour lire la première valeur d'une propriété Omeka
    function getFirstValue(propArray) {
        if (!propArray || !Array.isArray(propArray) || propArray.length === 0) return null;
        return propArray[0]["@value"] || null;
    }

    // 4) Fonction principale appelée au clic sur "Recharger"
    async function rechargerCours() {
        const status = document.getElementById("status");
        status.textContent = "Chargement des cours depuis http://localhost/omeka-s2…";

        try {
            const searchTerm = document.getElementById("search").value;
            const cours = await getCours(searchTerm);
            showCours(cours);
            status.textContent = "";
        } catch (e) {
            console.error(e);
            status.textContent = "Erreur lors du chargement des cours (voir la console).";
        }
    }

    // 5) Initialisation
    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("btn-reload").addEventListener("click", rechargerCours);

        // Rechargement automatique au chargement de la page
        rechargerCours();
    });
</script>
</body>
</html>
